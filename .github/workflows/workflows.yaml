# This workflow gathers the pipelines which will be executed on event bases.

name: workflows

on:
  push:
    branches:
      - devops/blackduck
jobs:
  # build
  build-prod:
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' && github.ref_name == 'main'
    uses: DicoAuto/actions/.github/workflows/web-build.yaml@development
    secrets: inherit
    with:
      runner: ubuntu-latest

  # lint
  linting:
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' && github.ref_name == 'main'
    uses: DicoAuto/actions/.github/workflows/web-lint.yaml@development
    secrets: inherit
    with:
      runner: ubuntu-latest

  # unit-tests
  tests:
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' && github.ref_name == 'main'
    uses: DicoAuto/actions/.github/workflows/web-test.yaml@development
    secrets: inherit
    with:
      runner: ubuntu-latest

  # sonarqube
  sonarqube:
    needs: [build-prod, linting, tests]
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' && github.ref_name == 'main'
    uses: DicoAuto/actions/.github/workflows/web-sonarqube.yaml@development
    secrets: inherit
    with:
      ref_branch: 'main'
      verbose: false
      runner: ubuntu-latest

  # deploy docs
  gh-pages:
    if: github.event_name == 'push' && github.ref_name == 'main'
    uses: DicoAuto/actions/.github/workflows/web-docs.yaml@development
    secrets: inherit
    with:
      runner: ubuntu-latest

  # deploy chromatic
  chromatic:
    needs: [build-prod, linting, tests]
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' && github.ref_name == 'main'
    uses: DicoAuto/actions/.github/workflows/web-chromatic.yaml@development
    secrets: inherit
    with:
      runner: ubuntu-latest
  
  setup_java:
    uses: actions/setup-java@v2
    with:
      java-version: '11'
      distribution: 'adopt'

  blackduck:
    uses: synopsys-sig/synopsys-action@v1.1.0
    with:
      blackduck_apiToken: ${{ secrets.BLACKDUCK_API_TOKEN }}
      blackduck_url: ${{ secrets.BLACKDUCK_URL }}
      blackduck_scan_full: true
      github_token: ${{ secrets.GITHUB_TOKEN }}
      blackduck_automation_fixpr: true
      blackduck_scan_failure_severities: "ALL"
